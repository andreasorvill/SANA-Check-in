<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SANA – Word Cloud Dashboard</title>

  <link rel="stylesheet" href="styles.css">

  <!-- d3 + d3-cloud -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-cloud/build/d3.layout.cloud.min.js"></script>

  <style>
    #cloud {
      width: 100%;
      height: 72vh;
      background: #1f1f1f;
      border-radius: 12px;
      position: relative;
      overflow: hidden;
    }

    svg {
      width: 100%;
      height: 100%;
    }

    .filter-container {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      color: #fff;
    }

    .filter-container select {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      background: #003d72;
      color: white;
      font-size: 14px;
    }
  </style>
</head>

<body class="dashboard-body">

  <div class="dashboard-container">

    <img src="images/SANA_simple.png" class="dashboard-logo" alt="SANA Logo">

    <h1 class="dashboard-title">Weekly Word Cloud</h1>
    <p class="dashboard-subtitle">Admin can filter by year and week.</p>

    <!-- ADMIN-ONLY FILTERS -->
    <div id="filters" class="filter-container" style="display:none;">
      <label>Year:</label>
      <select id="yearSelect"></select>

      <label>Week:</label>
      <select id="weekSelect">
        <option value="current">Current Week</option>
        <option value="all">All Weeks</option>
      </select>
    </div>

    <div id="cloud"></div>

    <div style="display:flex;gap:10px;justify-content:center;margin-top:18px;">
      <button class="back-btn" onclick="window.location.href='index.html'">← Back to Check-In</button>
      <button class="back-btn" id="reloadBtn" style="background:#003d72;color:#fff;">Reload</button>
    </div>

  </div>

<script>
const RAW_API =
  "https://script.google.com/macros/s/AKfycbwWDyuw9r1IQCWZzGBC2up3pN53X3BpjQRnCDRbZpXsmQ70UYTTjUQQUUXeR80YkqFXTg/exec";

const PROXY = "https://sana-cors-proxy.andreas-orvill.workers.dev/?url=";

function buildURL() {
  return PROXY + encodeURIComponent(RAW_API) + "&t=" + Date.now();
}

let allEntries = [];
let isAdmin = localStorage.getItem("role") === "admin";

// DOM
const yearSelect = document.getElementById("yearSelect");
const weekSelect = document.getElementById("weekSelect");
const filtersEl = document.getElementById("filters");

// Show filters only for admin
if (isAdmin) filtersEl.style.display = "flex";

async function loadData() {
  const res = await fetch(buildURL());
  allEntries = await res.json();
  console.log("Loaded entries:", allEntries);
}

function getCurrentISOWeek(date = new Date()) {
  date = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = date.getUTCDay() || 7;
  date.setUTCDate(date.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
  return Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
}

function buildFilters() {
  const years = [...new Set(allEntries.map(e => e.year))].sort();
  yearSelect.innerHTML = "";
  years.forEach(y => {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y;
    yearSelect.appendChild(opt);
  });

  // Default admin selection = current year
  const currentYear = new Date().getFullYear();
  if (years.includes(currentYear)) yearSelect.value = currentYear;

  updateWeekDropdown();
}

function updateWeekDropdown() {
  const selectedYear = Number(yearSelect.value);
  const weeks = [...new Set(allEntries
    .filter(e => e.year === selectedYear)
    .map(e => e.week)
  )].sort((a,b)=>a-b);

  weekSelect.innerHTML = `
    <option value="current">Current Week</option>
    <option value="all">All Weeks</option>
  `;

  weeks.forEach(w => {
    const opt = document.createElement("option");
    opt.value = w;
    opt.textContent = "Week " + w;
    weekSelect.appendChild(opt);
  });

  // Default admin = current week
  const currentWeek = getCurrentISOWeek();
  if (weeks.includes(currentWeek)) {
    weekSelect.value = currentWeek;
  }
}

function getFilteredEntries() {
  if (!isAdmin) return allEntries; // non-admin sees full cloud

  const year = Number(yearSelect.value);
  const week = weekSelect.value;

  return allEntries.filter(e => {
    if (e.year !== year) return false;

    if (week === "all") return true;
    if (week === "current") {
      return e.week === getCurrentISOWeek();
    }

    return e.week === Number(week);
  });
}

function renderCloud() {
  const entries = getFilteredEntries();

  const freq = {};
  entries.forEach(e => {
    e.words.forEach(w => {
      const clean = w.trim();
      freq[clean] = (freq[clean] || 0) + 1;
    });
  });

  const cloudWords = Object.keys(freq).map(word => ({
    text: word,
    size: freq[word]
  }));

  const cloudBox = document.getElementById("cloud");
  const width = cloudBox.clientWidth;
  const height = cloudBox.clientHeight;

  cloudBox.innerHTML = "";

  if (!cloudWords.length) {
    cloudBox.innerHTML = "<div style='color:#ccc;padding:20px'>No data for this selection.</div>";
    return;
  }

  const maxFreq = d3.max(cloudWords, d => d.size);

  const fontSize = d3.scaleSqrt()
    .domain([1, maxFreq])
    .range([15, 90]);

  const layout = d3.layout.cloud()
    .size([width, height])
    .words(cloudWords)
    .padding(8)
    .font("Arial")
    .fontSize(d => fontSize(d.size))
    .spiral("archimedean")
    .rotate(0)
    .on("end", words => {
      const svg = d3.select("#cloud").append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("transform", `translate(${width/2},${height/2})`);

      const color = d3.scaleLinear()
        .domain([1, maxFreq])
        .range(["#7fa9ff", "#ffb347"]);

      svg.selectAll("text")
        .data(words)
        .enter().append("text")
        .style("font-family", "Arial")
        .style("font-size", d => d.size + "px")
        .style("fill", d => color(freq[d.text]))
        .attr("text-anchor", "middle")
        .attr("transform", d => `translate(${d.x},${d.y})`)
        .text(d => d.text);
    });

  layout.start();
}

// EVENTS
yearSelect?.addEventListener("change", () => {
  updateWeekDropdown();
  renderCloud();
});

weekSelect?.addEventListener("change", renderCloud);

document.getElementById("reloadBtn").addEventListener("click", renderCloud);

// INITIAL LOAD
(async function init() {
  await loadData();

  if (isAdmin) {
    buildFilters();
  }

  renderCloud();
})();
</script>

</body>
</html>
